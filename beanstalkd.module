<?php

/**
 * @file
 * Provide core implementation of beanstalkd support for Queues
 */


/**
 * Implements hook_menu()
 */
function beanstalkd_menu() {
  $items = array();

  $items['admin/reports/beanstalkd'] = array(
    'title' => 'Beanstalkd Stats',
    'description' => 'Retreives statistics from the beanstalkd server.',
    'page callback' => 'beanstalkd_admin_stats',
    'access arguments' => array('access beanstalkd stats'),
    'file' => 'beanstalkd.admin.inc',
  );

  return $items;
}


/**
 * Implements hook_permission()
 */
function beanstalkd_permission() {
  return array(
    'access beanstalkd stats' => array(
      'title' => t('Access Beanstalkd Stats'),
      'description' => t('Access the statistics report for the beanstalkd server.'),
      'restrict access' => TRUE,
    ),
  );
}

/**
 * Implements hook_libraries_info().
 */
function beanstalkd_libraries_info() {
  $info = array();

  $info['pheanstalk'] = array(
    'name' => t('Pheanstalk'),
    'vendor url' => 'https://github.com/pda/pheanstalk',
    'download url' => 'https://github.com/pda/pheanstalk/tags',
    'path' => 'classes',
    'version callback' => 'beanstalkd_get_version',
    'version arguments' => array(
      'file' => 'classes/Pheanstalk/Pheanstalk.php',
      'pattern' => '/VERSION\s+=\s+\'(\d+\.\d+\.\d+)\';/',
      'lines' => 20,
      'cols' => 255,
    ),
    'files' => array(
      'php' => array('Pheanstalk/ClassLoader.php'),
    ),
    'callbacks' => array(
      'post-load' => array('beanstalkd_init_phpeanstalk'),
    ),
  );

  return $info;
}

function beanstalkd_get_version($library, $options) {
  // Provide defaults.
  $options += array(
    'file' => '',
    'pattern' => '',
    'lines' => 20,
    'cols' => 200,
  );

  $file = DRUPAL_ROOT . '/' . $library['library path'] . '/classes/Pheanstalk.php';
  if (file_exists($file)) {
    return '1.0';
  }

  $file = DRUPAL_ROOT . '/' . $library['library path'] . '/' . $options['file'];
  if (empty($options['file']) || !file_exists($file)) {
    return;
  }
  $file = fopen($file, 'r');
  while ($options['lines'] && $line = fgets($file, $options['cols'])) {
    if (preg_match($options['pattern'], $line, $version)) {
      fclose($file);
      return $version[1];
    }
    $options['lines']--;
  }
  fclose($file);
}

function beanstalkd_init_phpeanstalk($library) {
  if ($library['loaded']) {
    Pheanstalk_ClassLoader::register(DRUPAL_ROOT . '/' . $library['library path'] . '/' . $library['path']);
  }
}

/**
 * Load the pheanstalk library.
 */
function beanstalkd_load_pheanstalk() {
  $library = libraries_load('pheanstalk');

  if (!$library['loaded']) {
    throw new Exception('Unable to load Pheanstalk library');
  }

  return TRUE;
}

/**
 * Get Queue Parameters
 */
function beanstalkd_get_queue_options($name) {
  static $options = array();

  if (!isset($options[$name])) {
    $library = libraries_detect('pheanstalk');
    $class = version_compare($library['version'], '2.0.0', '>=') ? 'Pheanstalk_PheanstalkInterface' : 'Pheanstalk';

    $options[$name] = variable_get('beanstalk_queue_' . $name, array());
    $defaults = variable_get('beanstalk_default_queue', array()) + array(
      'host' => variable_get('beanstalkd_host', 'localhost'),
      'port' => variable_get('beanstalkd_port', $class::DEFAULT_PORT),
      'fork' => FALSE,
      'reserve_timeout' => 0,
      'ttr' => $class::DEFAULT_TTR,
      'priority' => $class::DEFAULT_PRIORITY,
      'release_delay' => $class::DEFAULT_DELAY,
      'forked_extra_timeout' => FALSE,
      'forked_extra_items' => FALSE,
      'delay' => $class::DEFAULT_DELAY,
    );
    $options[$name] += $defaults;
  }

  return $options[$name];
}

/**
 * Get a list of all queues which have drush enabled.
 *
 * @param $host
 *  The list of all the queue which are using this specified host
 *
 * @return
 *  If a host is specified then it returns an array of all the settings for the queue.
 *  otherwise if no host is specified then it will return an array keyed by host for all
 *  with the settings for all queues.
 */
function beanstalkd_get_host_queues($host = NULL, $queue_name = NULL) {
  static $queue_list;

  if (!isset($queue_list)) {
    $queue_list = array();
    $cron_queues = module_invoke_all('cron_queue_info');
    drupal_alter('cron_queue_info', $cron_queues);

    // Additionally, check for modules implementing hook_queue_info.
    $queues = module_invoke_all('queue_info');
    drupal_alter('queue_info', $queues);
    $queues = array_merge($queues, $cron_queues);

    foreach ($queues as $queue => $settings) {
      $name = 'queue_class_' . $queue;
      $options = beanstalkd_get_queue_options($queue);
      if (variable_get($name, variable_get('queue_default_class', 'SystemQueue')) == 'BeanstalkdQueue') {
        $settings['options'] = $options;
        $queue_list[$options['host'] . ':' . $options['port']][$queue] = $settings;
      }
    }
  }

  if ($queue_name) {
    $options = beanstalkd_get_queue_options($queue_name);
    $host = $options['host'] . ':' . $options['port'];
    return isset($queue_list[$host][$queue_name]) ? $queue_list[$host][$queue_name] : array();
  }
  if ($host) {
    return isset($queue_list[$host]) ? $queue_list[$host] : array();
  }
  return $queue_list;
}

function beanstalkd_get_queues($hostname = NULL) {
  $queues = beanstalkd_get_host_queues($hostname);

  if ($hostname) {
    $names = array_keys($queues);
  }
  else {
    $names = array();
    foreach ($queues as $hostname => $settings) {
      $names = array_merge($names, array_keys($settings));
    }
  }

  return $names;
}

function beanstalkd_get_classname() {
  $library = libraries_detect('pheanstalk');
  if (version_compare($library['version'], '2.0.0', '>=')) {
    return 'Pheanstalk_Pheanstalk';
  }
  else {
    return 'Pheanstalk';
  }
}

function beanstalkd_get_interface() {
  $library = libraries_detect('pheanstalk');
  if (version_compare($library['version'], '2.0.0', '>=')) {
    return 'Pheanstalk_PheanstalkInterface';
  }
  else {
    return 'Pheanstalk';
  }
}
